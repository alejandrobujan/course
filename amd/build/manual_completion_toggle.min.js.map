{"version":3,"sources":["../src/manual_completion_toggle.js"],"names":["SELECTORS","MANUAL_TOGGLE","TOGGLE_TYPES","TOGGLE_MARK_DONE","TOGGLE_UNDO","registered","id","user","coursename","courseid","init","first","second","third","last","document","addEventListener","e","toggleButton","target","closest","preventDefault","toggleManualCompletionState","catch","Notification","exception","originalInnerHtml","innerHTML","setAttribute","toggleType","getAttribute","cmid","activityname","completed","Templates","render","loadingHtml","replaceNodeContents","templateContext","overallcomplete","overallincomplete","istrackeduser","renderForPromise","renderObject","replaceNode","html","js","replacedNode","newToggleButton","pop","withAvailability","toggledEvent","CustomEvent","CourseEvents","manualCompletionToggled","bubbles","detail","dispatchEvent","dt","Date","toLocaleDateString","toLocaleTimeString","msg1","msg2","msg3","http","XMLHttpRequest","url","params","open","setRequestHeader","onreadystatechange","readyState","status","send","removeAttribute"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides the functionality for toggling the manual completion state of a course module through\n * the manual completion button.\n *\n * @module      core_course/manual_completion_toggle\n * @copyright   2021 Jun Pataleta <jun@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {toggleManualCompletion} from 'core_course/repository';\nimport * as CourseEvents from 'core_course/events';\n\n/**\n * Selectors in the manual completion template.\n *\n * @type {{MANUAL_TOGGLE: string}}\n */\nconst SELECTORS = {\n    MANUAL_TOGGLE: 'button[data-action=toggle-manual-completion]',\n};\n\n/**\n * Toggle type values for the data-toggletype attribute in the core_course/completion_manual template.\n *\n * @type {{TOGGLE_UNDO: string, TOGGLE_MARK_DONE: string}}\n */\nconst TOGGLE_TYPES = {\n    TOGGLE_MARK_DONE: 'manual:mark-done',\n    TOGGLE_UNDO: 'manual:undo',\n};\n\n/**\n * Whether the event listener has already been registered for this module.\n *\n * @type {boolean}\n */\nlet registered = false;\nlet id;\nlet user;\nlet coursename;\nlet courseid;\n/**\n * Registers the click event listener for the manual completion toggle button.\n */\nexport const init = (first, second, third, last) => {\n    if (registered) {\n        return;\n    }\n    document.addEventListener('click', (e) => {\n        const toggleButton = e.target.closest(SELECTORS.MANUAL_TOGGLE);\n        if (toggleButton) {\n            e.preventDefault();\n            toggleManualCompletionState(toggleButton).catch(Notification.exception);\n        }\n    });\n    id = first;\n    user = second;\n    coursename = third;\n    courseid = last;\n    registered = true;\n};\n\n/**\n * Toggles the manual completion state of the module for the given user.\n *\n * @param {HTMLElement} toggleButton\n * @returns {Promise<void>}\n */\nconst toggleManualCompletionState = async(toggleButton) => {\n    // Make a copy of the original content of the button.\n    const originalInnerHtml = toggleButton.innerHTML;\n\n    // Disable the button to prevent double clicks.\n    toggleButton.setAttribute('disabled', 'disabled');\n\n    // Get button data.\n    const toggleType = toggleButton.getAttribute('data-toggletype');\n    const cmid = toggleButton.getAttribute('data-cmid');\n    const activityname = toggleButton.getAttribute('data-activityname');\n    // Get the target completion state.\n    const completed = toggleType === TOGGLE_TYPES.TOGGLE_MARK_DONE;\n\n    // Replace the button contents with the loading icon.\n    const loadingHtml = await Templates.render('core/loading', {});\n    await Templates.replaceNodeContents(toggleButton, loadingHtml, '');\n\n    try {\n        // Call the webservice to update the manual completion status.\n        await toggleManualCompletion(cmid, completed);\n\n        // All good so far. Refresh the manual completion button to reflect its new state by re-rendering the template.\n        const templateContext = {\n            cmid: cmid,\n            activityname: activityname,\n            overallcomplete: completed,\n            overallincomplete: !completed,\n            istrackeduser: true, // We know that we're tracking completion for this user given the presence of this button.\n        };\n        const renderObject = await Templates.renderForPromise('core_course/completion_manual', templateContext);\n\n        // Replace the toggle button with the newly loaded template.\n        const replacedNode = await Templates.replaceNode(toggleButton, renderObject.html, renderObject.js);\n        const newToggleButton = replacedNode.pop();\n\n        // Build manualCompletionToggled custom event.\n        const withAvailability = toggleButton.getAttribute('data-withavailability');\n        const toggledEvent = new CustomEvent(CourseEvents.manualCompletionToggled, {\n            bubbles: true,\n            detail: {\n                cmid,\n                activityname,\n                completed,\n                withAvailability,\n            }\n        });\n        // Dispatch the manualCompletionToggled custom event.\n        newToggleButton.dispatchEvent(toggledEvent);\n        if(completed){\n            const dt = \"<b>\"+new Date().toLocaleDateString() + \" \" + new Date().toLocaleTimeString()+\"</b>\";\n            const msg1 = dt + \" <a href='../user/profile.php?id=\"+ id +\"'>\" + user + \"</a> has completed \";\n            const msg2 = msg1 + activityname + \" in <a href='../course/view.php?id=\"+courseid+\"'>\" + coursename + \"</a>\";\n            const msg3 = msg2 + \". <a href='../message/index.php?id=\"+ id +\"'>Ask how!</a><br>\";\n            var http = new XMLHttpRequest();\n            var url = \"view.php?id=\"+courseid;\n            var params = \"line=\"+msg3;\n            http.open(\"POST\", url, true);\n            http.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n            http.onreadystatechange = function() {\n                if(http.readyState == 4 && http.status == 200) {\n                    //alert(http.responseText);\n                }\n            };\n            http.send(params);\n        }\n\n    } catch (exception) {\n        // In case of an error, revert the original state and appearance of the button.\n        toggleButton.removeAttribute('disabled');\n        toggleButton.innerHTML = originalInnerHtml;\n\n        // Show the exception.\n        Notification.exception(exception);\n    }\n};\n"],"file":"manual_completion_toggle.min.js"}